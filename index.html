<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>第19期 チーム希望エントリー</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        
        /* iPhone X+ Safe Area Support */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .mb-safe { margin-bottom: env(safe-area-inset-bottom); }
        .bottom-safe { bottom: env(safe-area-inset-bottom); }
        
        /* Mobile Input Zoom Fix */
        input, select, textarea { font-size: 16px !important; }

        .tap-scale:active { transform: scale(0.97); transition: transform 0.1s; }
        
        /* Hide scrollbar for clean UI */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        // ▼▼▼ Firebase設定 ▼▼▼
        const firebaseConfig = {
            apiKey: "AIzaSyCesxY149Fx77NDwnplZBCH06dekDcduA4",
            authDomain: "team-entry.firebaseapp.com",
            projectId: "team-entry",
            storageBucket: "team-entry.firebasestorage.app",
            messagingSenderId: "137873897281",
            appId: "1:137873897281:web:67b999f86431d0e20213c0",
            measurementId: "G-KLBEB481CY"
        };
        // ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        // Initialize Firebase
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase init error. Config might be missing.", e);
        }
        
        const appId = 'doyukai-19th-team-selector';
        const { useState, useEffect } = React;

        const Icon = ({ name, className }) => {
            useEffect(() => { lucide.createIcons(); }, [name]);
            return <i data-lucide={name} className={className}></i>;
        };

        const TEAMS = [
            { 
                id: 'learn', 
                title: '事業承継・学び', 
                subtitle: '実践報告例会', 
                color: 'bg-amber-50 border-amber-200 text-amber-800', 
                icon: 'book-open', 
                details: [
                    '【主な担当】実践報告例会', 
                    '【得られるもの】事業承継について'
                ] 
            },
            { 
                id: 'org', 
                title: '組織・仲間づくり', 
                subtitle: '家族例会・組織創り', 
                color: 'bg-emerald-50 border-emerald-200 text-emerald-800', 
                icon: 'users', 
                details: [
                    '【主な担当】家族例会の設営、強い組織作り', 
                    '【得られるもの】家族ぐるみの交流、組織運営について'
                ] 
            },
            { 
                id: 'vision', 
                title: 'ビジョン・AI', 
                subtitle: '11月フォーラム・AI活用', 
                color: 'bg-blue-50 border-blue-200 text-blue-800', 
                icon: 'target', 
                details: [
                    '【主な担当】11月経営フォーラム、AI勉強会', 
                    '【得られるもの】最新AIスキル、自社のビジョン'
                ] 
            },
            { 
                id: 'region', 
                title: '地域・広域連携', 
                subtitle: '天草連携・全国行事', 
                color: 'bg-rose-50 border-rose-200 text-rose-800', 
                icon: 'map-pin', 
                details: [
                    '【主な担当】天草合同例会、他支部連携', 
                    '【得られるもの】各支部との強い繋がり'
                ] 
            }
        ];

        function App() {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('entry');
            const [isAdminUnlocked, setIsAdminUnlocked] = useState(false);
            const [selectedTeam, setSelectedTeam] = useState(null);
            const [name, setName] = useState('');
            // company state removed
            const [choices, setChoices] = useState({ first: null, second: null, third: null });
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [allEntries, setAllEntries] = useState([]);

            useEffect(() => {
                if(!auth) return;
                signInAnonymously(auth);
                onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    if(u) loadData(u.uid);
                });
            }, []);

            const loadData = (uid) => {
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'team_preferences'));
                onSnapshot(q, (snapshot) => {
                    const data = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    setAllEntries(data);
                    const myEntry = data.find(d => d.id === uid);
                    if (myEntry) {
                        setName(myEntry.name);
                        setChoices(myEntry.choices);
                    }
                });
            };

            const handleSelect = (rank, teamId) => {
                setChoices(prev => {
                    const next = { ...prev };
                    if (next.first === teamId) next.first = null;
                    if (next.second === teamId) next.second = null;
                    if (next.third === teamId) next.third = null;
                    next[rank] = teamId;
                    return next;
                });
                setSelectedTeam(null);
            };

            const handleSubmit = async () => {
                if (!name || !choices.first) return alert("お名前と第1希望は必須です");
                setIsSubmitting(true);
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'team_preferences', user.uid), {
                        name, choices, updatedAt: new Date().toISOString()
                    });
                    alert("送信しました！");
                } catch (e) {
                    console.error(e);
                    alert("送信エラー: Firebase設定を確認してください");
                }
                setIsSubmitting(false);
            };

            const handleReset = async () => {
                if(!confirm("【注意】\n全ての投票データを削除してリセットしますか？")) return;
                const p = prompt("パスワード(1919)を入力");
                if(p !== "1919") return alert("パスワードが違います");
                setIsSubmitting(true);
                try {
                    await Promise.all(allEntries.map(e => deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'team_preferences', e.id))));
                    alert("リセット完了");
                } catch(e) { alert("エラー: " + e.message); }
                setIsSubmitting(false);
            };

            const handleAdminAccess = () => {
                if (isAdminUnlocked) { setActiveTab('admin'); return; }
                const pass = prompt("集計閲覧用パスワード(1919)");
                if (pass === "1919") { setIsAdminUnlocked(true); setActiveTab('admin'); }
                else if (pass !== null) { alert("パスワードが違います"); }
            };

            const getStats = () => {
                const stats = {};
                TEAMS.forEach(t => stats[t.id] = { first: 0, second: 0, third: 0 });
                allEntries.forEach(e => {
                    if (e.choices.first) stats[e.choices.first].first++;
                    if (e.choices.second) stats[e.choices.second].second++;
                    if (e.choices.third) stats[e.choices.third].third++;
                });
                return stats;
            };
            const stats = getStats();

            if (!auth) return <div className="flex h-screen items-center justify-center text-slate-400 font-bold">読み込み中...</div>;

            return (
                <div className="max-w-md mx-auto min-h-screen pb-safe bg-slate-50">
                    <header className="bg-white/90 backdrop-blur-md border-b border-slate-200 sticky top-0 z-30 px-4 py-3 flex justify-between items-center shadow-sm">
                        <div className="flex flex-col">
                            <h1 className="text-base font-black text-slate-800">第19期 チーム希望</h1>
                            <p className="text-[10px] font-bold text-blue-600 tracking-wider">DRAFT SELECTION</p>
                        </div>
                        <div className="flex bg-slate-100 p-1 rounded-lg">
                            <button onClick={()=>setActiveTab('entry')} className={`px-3 py-1.5 text-xs font-bold rounded-md transition-all ${activeTab==='entry'?'bg-white text-blue-600 shadow-sm':'text-slate-400'}`}>入力</button>
                            <button onClick={handleAdminAccess} className={`px-3 py-1.5 text-xs font-bold rounded-md transition-all ${activeTab==='admin'?'bg-white text-blue-600 shadow-sm':'text-slate-400'}`}>集計</button>
                        </div>
                    </header>

                    <main className="p-4 pb-32 space-y-6">
                        {activeTab === 'entry' ? (
                            <>
                                <div className="bg-white p-5 rounded-2xl border border-slate-100 shadow-sm space-y-4">
                                    <h2 className="text-xs font-black text-slate-400 uppercase tracking-widest flex items-center gap-1"><Icon name="user-circle-2" className="w-4 h-4"/> YOUR PROFILE</h2>
                                    <div className="space-y-3">
                                        <input type="text" placeholder="お名前 (必須)" value={name} onChange={e=>setName(e.target.value)} className="w-full bg-slate-50 px-4 py-3 rounded-xl text-base font-bold outline-none border border-slate-100 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all placeholder:font-medium placeholder:text-slate-300" />
                                    </div>
                                </div>

                                {/* 案内文エリア */}
                                <div className="bg-blue-50 p-4 rounded-xl border border-blue-100 flex gap-3 items-start">
                                    <Icon name="info" className="w-5 h-5 text-blue-600 shrink-0 mt-0.5" />
                                    <p className="text-sm text-blue-800 font-bold leading-relaxed">
                                        下の「TEAM LIST」から各チームの<br/>詳細をよく確認してから、<br/>
                                        希望順位を選択してください。
                                    </p>
                                </div>

                                {/* TEAM LISTを先に表示 */}
                                <div className="grid gap-3">
                                    <h2 className="text-xs font-black text-slate-400 uppercase tracking-widest px-1 mt-2">TEAM LIST</h2>
                                    {TEAMS.map(team => (
                                        <div key={team.id} onClick={()=>setSelectedTeam(team)} className={`relative border rounded-2xl p-5 tap-scale transition-all active:brightness-95 cursor-pointer bg-white ${team.color.replace('text-', 'border-').split(' ')[1]}`}>
                                            <div className="flex justify-between items-start mb-3">
                                                <div className={`p-2.5 rounded-xl shadow-sm ${team.color.replace('text-', 'bg-').split(' ')[0]} bg-opacity-10`}><Icon name={team.icon} className={`w-6 h-6 ${team.color.split(' ')[2]}`}/></div>
                                                <div className="bg-slate-100 px-2.5 py-1 rounded-full text-[10px] font-bold flex items-center gap-1 text-slate-500">詳細 <Icon name="chevron-right" className="w-3 h-3"/></div>
                                            </div>
                                            <h3 className="font-black text-lg text-slate-800 leading-tight mb-1">{team.title}</h3>
                                            <p className="text-xs font-bold opacity-60 text-slate-500">{team.subtitle}</p>
                                            
                                            {/* Badges */}
                                            <div className="absolute top-4 right-4 flex flex-col gap-1 items-end">
                                            {Object.entries(choices).map(([r, id]) => id === team.id && (
                                                <div key={r} className={`text-white text-[10px] font-black px-2 py-0.5 rounded shadow-sm ${r==='first'?'bg-amber-400':r==='second'?'bg-slate-300':'bg-orange-300'}`}>
                                                    {r==='first'?'第1希望':r==='second'?'第2希望':'第3希望'}
                                                </div>
                                            ))}
                                            </div>
                                        </div>
                                    ))}
                                </div>

                                {/* YOUR CHOICEを後に表示 */}
                                <div className="space-y-2">
                                    <h2 className="text-xs font-black text-slate-400 uppercase tracking-widest px-1">YOUR CHOICE</h2>
                                    {['first','second','third'].map((rank, i) => {
                                        const team = TEAMS.find(t=>t.id===choices[rank]);
                                        return (
                                            <div key={rank} className="bg-white border border-slate-200 p-3 rounded-xl flex items-center gap-3 shadow-sm min-h-[64px]">
                                                <div className={`w-8 h-8 rounded-full flex items-center justify-center text-white font-black text-xs shadow-sm shrink-0 ${i===0?'bg-amber-400':i===1?'bg-slate-300':'bg-orange-300'}`}>{i+1}</div>
                                                {team ? (
                                                    <div className="flex-1 flex justify-between items-center overflow-hidden">
                                                        <div className="truncate pr-2"><div className="font-bold text-sm text-slate-700 truncate">{team.title}</div></div>
                                                        <button onClick={()=>handleSelect(rank, null)} className="text-slate-300 p-2 active:text-red-500"><Icon name="x" className="w-4 h-4"/></button>
                                                    </div>
                                                ) : <span className="text-xs font-bold text-slate-300">↓ チーム詳細から選んでください</span>}
                                            </div>
                                        );
                                    })}
                                </div>

                                {/* Fixed Bottom Button */}
                                <div className="fixed bottom-0 left-0 right-0 p-4 pb-safe bg-white/80 backdrop-blur-lg border-t border-slate-200 z-20">
                                    <div className="max-w-md mx-auto">
                                        <button onClick={handleSubmit} disabled={isSubmitting} className="w-full bg-blue-600 text-white py-4 rounded-xl font-black text-lg shadow-lg shadow-blue-200 active:scale-95 transition-all disabled:opacity-50 disabled:active:scale-100 flex items-center justify-center gap-2">
                                            {isSubmitting ? <><Icon name="loader-2" className="w-5 h-5 animate-spin"/> 送信中...</> : 'この内容でエントリーする'}
                                        </button>
                                    </div>
                                </div>
                            </>
                        ) : (
                            // Admin Tab (Same content, kept simple for mobile)
                            <div className="space-y-4 pb-10">
                                <div className="bg-slate-800 text-white p-5 rounded-2xl shadow-lg">
                                    <h2 className="font-bold flex items-center gap-2"><Icon name="bar-chart-3" className="w-5 h-5"/> エントリー状況</h2>
                                    <p className="text-sm mt-1 opacity-80">回答数: <span className="text-2xl font-black">{allEntries.length}</span></p>
                                </div>
                                {TEAMS.map(team => {
                                    const s = stats[team.id];
                                    const total = s.first + s.second + s.third;
                                    return (
                                        <div key={team.id} className="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm">
                                            <div className="flex gap-3 mb-4 items-center border-b border-slate-50 pb-3">
                                                <div className={`p-2 rounded-lg bg-slate-50`}><Icon name={team.icon} className={`w-5 h-5 text-slate-500`}/></div>
                                                <div><h3 className="font-bold text-slate-800 text-sm">{team.title}</h3><div className="text-[10px] font-bold text-slate-400">TOTAL: {total}票</div></div>
                                            </div>
                                            <div className="space-y-4">
                                                {['first','second','third'].map((r, i) => (
                                                    <div key={r}>
                                                        <div className="flex items-center gap-2 mb-1">
                                                            <span className={`text-[10px] font-black px-1.5 py-0.5 rounded text-white ${i===0?'bg-amber-400':i===1?'bg-slate-300':'bg-orange-300'}`}>第{i+1}希望</span>
                                                            <span className="text-xs font-bold text-slate-300">{s[r]}票</span>
                                                        </div>
                                                        <div className="flex flex-wrap gap-1">
                                                            {allEntries.filter(e=>e.choices[r]===team.id).map(e=>
                                                                <span key={e.id} className="bg-slate-50 text-slate-600 border border-slate-100 px-2 py-1 rounded text-[10px] font-bold">{e.name}</span>
                                                            )}
                                                            {allEntries.filter(e=>e.choices[r]===team.id).length===0 && <span className="text-[10px] text-slate-200">-</span>}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )
                                })}
                                <button onClick={handleReset} className="w-full py-4 mt-8 text-rose-500 font-bold text-xs border border-rose-100 rounded-xl bg-rose-50 flex items-center justify-center gap-2 mb-safe">
                                    <Icon name="trash-2" className="w-4 h-4" /> 全データをリセット
                                </button>
                            </div>
                        )}
                    </main>

                    {/* Mobile Bottom Sheet Modal */}
                    {selectedTeam && (
                        <div className="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm flex items-end justify-center animate-in fade-in duration-200" onClick={()=>setSelectedTeam(null)}>
                            <div className="bg-white w-full max-w-md rounded-t-3xl overflow-hidden shadow-2xl animate-in slide-in-from-bottom duration-300 pb-safe" onClick={e=>e.stopPropagation()}>
                                <div className={`p-6 ${selectedTeam.color.split(' ')[0]} bg-opacity-20`}>
                                    <div className="flex justify-between items-start mb-2">
                                        <div className="bg-white p-3 rounded-2xl shadow-sm inline-block"><Icon name={selectedTeam.icon} className={`w-8 h-8 ${selectedTeam.color.split(' ')[2]}`}/></div>
                                        <button onClick={()=>setSelectedTeam(null)} className="bg-white/50 p-2 rounded-full active:bg-white"><Icon name="x" className="w-5 h-5 text-slate-500"/></button>
                                    </div>
                                    <h2 className="text-2xl font-black text-slate-800 leading-tight">{selectedTeam.title}</h2>
                                    <p className="font-bold text-slate-500 text-sm mt-1">{selectedTeam.subtitle}</p>
                                </div>
                                <div className="p-6 space-y-6 max-h-[60vh] overflow-y-auto">
                                    <div className="space-y-3">
                                        {selectedTeam.details.map((d,i)=>(
                                            <div key={i} className="flex gap-3 text-sm bg-slate-50 p-3 rounded-xl border border-slate-100">
                                                <Icon name="check-circle-2" className="w-5 h-5 text-blue-500 shrink-0 mt-0.5"/>
                                                <span className="text-slate-700 font-medium leading-snug">{d}</span>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="grid grid-cols-3 gap-3 pt-2 pb-4">
                                        {['first','second','third'].map((r,i)=>(
                                            <button key={r} onClick={()=>{handleSelect(r, selectedTeam.id); setSelectedTeam(null);}} className={`py-3 rounded-xl text-xs font-bold border-2 tap-scale ${choices[r]===selectedTeam.id?'bg-slate-800 text-white border-slate-800':'bg-white text-slate-500 border-slate-200'}`}>
                                                第{i+1}希望
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

